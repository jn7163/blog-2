{% extends "base.html" %}

{% block title %}Edit{% end %}

{% block head %}
<link rel="stylesheet" href="/static/codemirror/lib/codemirror.css"/>
<link rel="stylesheet" href="/static/codemirror/theme/elegant.css"/>
<script src="/static/codemirror/lib/codemirror.js"></script>
<script src="/static/codemirror/mode/rst/rst.js"></script>
<script src="/static/codemirror/addon/selection/active-line.js"></script>
<script src="/static/codemirror/addon/display/fullscreen.js"></script>
<link rel="stylesheet" href="/static/codemirror/addon/display/fullscreen.css"/>
<style>
  .CodeMirror-fullscreen {
    padding-top: 70px;
  }
  .CodeMirror-scroll {
    overflow-y: hidden;
    overflow-x: auto;
  }

  .CodeMirror {
    line-height: 1.3em;
    font-family: monospace;

    /* Necessary so the scrollbar can be absolutely positioned within the wrapper on Lion. */
    position: relative;
    /* This prevents unwanted scrollbars from showing up on the body and wrapper in IE. */
    overflow: hidden;
    background-color: white;
    width: 530px;

    /* Copied from Bootstrap's textarea */
    display: inline-block;
    padding: 4px 6px;
    margin-bottom: 9px;
    color: #555555;
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075);
    -webkit-transition: border linear 0.2s, box-shadow linear 0.2s;
    -moz-transition: border linear 0.2s, box-shadow linear 0.2s;
    -ms-transition: border linear 0.2s, box-shadow linear 0.2s;
    -o-transition: border linear 0.2s, box-shadow linear 0.2s;
    transition: border linear 0.2s, box-shadow linear 0.2s;  

    height: auto;
  }

  .CodeMirror-focused {
    /* Copied from Bootstrap's textarea */
    border-color: rgba(82, 168, 236, 0.8);
    outline: 0;
    outline: thin dotted \9;
    /* IE6-9 */

    -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
    -moz-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);
    box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.075), 0 0 8px rgba(82, 168, 236, 0.6);  
  }
</style>
{% end %}


{% block content %}
<div class="container">
  <div class="page-header">
    <h1>Article Editor
      <p class="pull-right">
        <button type="button" class="btn btn-primary" id="edit_submit" data-loading-text="Submiting...">Save</button>
        <a type="button" class="btn btn-default" href="{{ refurl }}">Close</a>
      </p>
    </h1>
  </div>
  <div class="alert alert-dismissable alert-danger fade in" style="display: none;">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
    <strong>Oh snap!</strong> <p id="alert_text"></p>
  </div>
  <form class="form-horizontal" role="form">
    <div class="form-group">
      <label class="col-md-1 control-label">Title</label>
      <div class="col-md-11">
        <input type="text" class="form-control" id="edit_title" placeholder="Title" value="{{ title }}">
      </div>
    </div>
    <div class="form-group">
      <label class="col-md-1 control-label">Tags</label>
      <div class="col-md-11">
        <input type="text" class="form-control" id="edit_tags" placeholder="Tags" value="{{ categories }}">
      </div>
    </div>
    <div class="form-group">
      <label class="col-md-1 control-label">Content</label>
      <div class="col-md-11">
        <textarea id="edit_content">{{ content }}</textarea>
      </div>
    </div>
  </form>
</div>

<script>
  var textarea_edit = document.getElementById("edit_content");
  
  var editor = CodeMirror.fromTextArea(textarea_edit, {
    theme: 'cm-s-elegant',
    lineWrapping: true,
    lineNumbers: true,
    extraKeys: {
      "F11": function(cm) {
        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
      },
      "Esc": function(cm) {
        if (cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
      }
    }
  });
  var do_submit = function() {
    $("#edit_submit").click(function(e) {
      $(this).button('loading');
      $(".alert").hide();
      editor.save();
      var btn = $(this);
      $.ajax({
        url: '',
        type: 'POST',
        data: {
          'title': $("#edit_title").val(),
          'categories': $("#edit_tags").val(),
          'content': $("#edit_content").val()
        },
        success: function(data) {
          if (data.success) {
            location.href = "/blog/article/" + data.article_id;
          }
          else {
            $("#alert_text").html(data.msg)
            $(".alert").show();
          }
          btn.button('reset');
        },
        error: function(xhr, errmsg, except) {
          $("#alert_text").html(errmsg)
          btn.button('reset');
        }
      });
    });
  };
  $(document).ready(function() {
    do_submit();
  });
</script>
{% end %}


